# 任务调度系统基础使用手册

## 1. 系统概述

本任务调度系统是一个基于STM32F10x系列单片机的轻量级实时操作系统，提供了任务管理、CPU利用率监控和内存池管理等功能。系统具有以下特点：

- 支持最多10个任务的创建和管理
- 基于时间片轮转的任务调度策略
- 提供任务挂起、恢复、修改执行间隔等操作
- 实时监控CPU利用率
- 内置内存池管理，避免内存碎片

## 2. 环境要求

- 硬件平台：STM32F10x系列单片机
- 开发环境：Keil MDK
- 相关库：STM32F10x标准库

## 3. 系统初始化

### 3.1 基本初始化流程

在使用任务调度系统前，必须按照以下顺序进行初始化：

1. 初始化硬件和系统时钟
2. 初始化延时函数
3. 初始化内存池
4. 初始化任务调度系统
5. 添加任务

```c
// 系统初始化示例
void Initialization(void){
    SystemInit();                  // STM32系统初始化
    Delay_Init();                  // 延时函数初始化
    MemPool_Init();                // 内存池初始化
    Task_Init();                   // 任务调度系统初始化
    
    // 添加任务
    Task_Add(TaskFunction, 100, "MyTask");  // 每100ms执行一次
    
    // 添加CPU利用率计算任务
    CPUUtil_Init();
    Task_Add(CPUUtil_CalculateTask, 500, "CPUUtil");
}
```

## 4. 任务管理

### 4.1 创建任务

使用`Task_Add`函数创建周期性任务：

```c
/**
 * @brief 添加新任务
 * @param task_func 任务函数指针（void func(void)形式）
 * @param interval 执行间隔（毫秒），0表示每次调度循环都执行
 * @param name 任务名称（用于调试）
 * @return TaskID 分配的任务ID（INVALID_TASK_ID表示添加失败）
 */
TaskID task_id = Task_Add(TaskFunction, 100, "MyTask");
```

### 4.2 创建一次性任务

使用`Task_AddOneShot`函数创建只执行一次的任务：

```c
/**
 * @brief 添加一次性任务
 * @param task_func 任务函数指针
 * @param delay 延迟执行时间(毫秒)
 * @param name 任务名称
 * @return TaskID 返回的任务ID
 */
TaskID one_shot_id = Task_AddOneShot(OneShotFunction, 1000, "OneShotTask");
```

### 4.3 挂起任务

使用`Task_Suspend`函数暂停任务执行：

```c
Task_Suspend(task_id);
```

### 4.4 恢复任务

使用`Task_Resume`函数恢复被挂起的任务：

```c
Task_Resume(task_id);
```

### 4.5 修改任务执行间隔

使用`Task_ChangeInterval`函数动态修改任务的执行频率：

```c
Task_ChangeInterval(task_id, 200);  // 修改为每200ms执行一次
```

### 4.6 删除任务

使用`Task_Remove`函数删除不再需要的任务：

```c
Task_Remove(task_id);
```

## 5. 运行任务调度器

在主函数的无限循环中调用`Task_RunScheduler`函数：

```c
int main(void) {
    Initialization();
    
    while(1) {
        Task_RunScheduler();  // 运行任务调度器
    }
}
```

## 6. CPU利用率监控

### 6.1 初始化CPU利用率监控

```c
CPUUtil_Init();
```

### 6.2 获取CPU利用率

```c
float cpu_usage = CPUUtil_GetTotalUsage();  // 获取总体CPU利用率
float task_usage = CPUUtil_GetTaskUsage(task_id);  // 获取指定任务的CPU利用率
```

## 7. 内存池管理

### 7.1 初始化内存池

```c
MemPool_Init();
```

### 7.2 分配内存

```c
void* ptr = MemPool_Alloc();
if (ptr != NULL) {
    // 使用分配的内存
}
```

### 7.3 释放内存

```c
MemPool_Free(ptr);
```

### 7.4 获取内存池使用率

```c
float mem_usage = MemPool_GetUsage();
```

## 8. 系统时间

使用`Task_GetSystemTime`函数获取系统当前时间（毫秒）：

```c
uint32_t current_time = Task_GetSystemTime();
```

## 9. 示例任务函数

任务函数必须是无参数无返回值的函数：

```c
void MyTaskFunction(void) {
    // 任务代码
    // 注意：避免在任务中使用长延时阻塞函数
}
```

## 10. 注意事项

1. 任务函数应尽量简短，避免长时间阻塞
2. 最多可创建10个任务
3. 任务ID范围为0-9，INVALID_TASK_ID(0xFF)表示无效ID
4. 任务间隔最小为1毫秒
5. 在任务中应避免使用递归或大量局部变量，以防栈溢出